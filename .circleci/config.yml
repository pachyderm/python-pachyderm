version: 2.1

jobs:
  tox:
    resource_class: large
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: etc/testing/circle/install.sh
      - run:
          name: Start minikube
          command: etc/testing/circle/start-minikube.sh
      - run:
          name: Deploy pachyderm
          command: etc/testing/circle/deploy-pachyderm.sh
      - run:
          name: TOXENV=py39 tox
          command: |
            set -x
            nohup pachctl port-forward &
            sleep 3
            until pachctl version; do sleep 1; done
            pachctl create repo foo
            echo data | pachctl put file foo@master:/data
            pachctl list repo
            pachctl list commit foo
            pachctl get file foo@master:/data
            exit 1
          environment:
            TOXENV: py39
      - run:
          when: on_fail
          command: etc/testing/circle/kube_debug.sh
workflows:
  circleci:
    jobs:
      - tox
